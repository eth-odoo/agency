<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Ticket Overview Page -->
        <template id="agency_ticket_overview" name="Agency Ticket Overview">
            <t t-call="eth_agency_portal.agency_base_template">
                <t t-set="head">
                    <style>
                        .stat-card {
                            background: white;
                            border-radius: 12px;
                            padding: 1.5rem;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                            transition: transform 0.2s;
                        }
                        .stat-card:hover {
                            transform: translateY(-3px);
                        }
                        .stat-icon {
                            width: 50px;
                            height: 50px;
                            border-radius: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.5rem;
                        }
                        .stat-value {
                            font-size: 2rem;
                            font-weight: 700;
                            color: #333;
                        }
                        .stat-label {
                            color: #666;
                            font-size: 0.9rem;
                        }
                        .orders-table {
                            background: white;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                        }
                        .orders-table th {
                            background: #f8f9fa;
                            font-weight: 600;
                            color: #495057;
                            border: none;
                        }
                        .orders-table td {
                            vertical-align: middle;
                            border-color: #f1f1f1;
                        }
                        .status-badge {
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.8rem;
                            font-weight: 500;
                        }
                        .status-draft { background: #fff3cd; color: #856404; }
                        .status-sent { background: #cce5ff; color: #004085; }
                        .status-sale { background: #d4edda; color: #155724; }
                        .status-cancel { background: #f8d7da; color: #721c24; }
                        .filter-card {
                            background: white;
                            border-radius: 12px;
                            padding: 1rem 1.5rem;
                            margin-bottom: 1.5rem;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                        }
                        .action-btn {
                            padding: 4px 10px;
                            border-radius: 6px;
                            font-size: 0.85rem;
                        }
                    </style>
                </t>

                <div class="container-fluid py-4">
                    <!-- Page Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">
                            <i class="fas fa-clipboard-list me-2 text-primary"></i>
                            Ticket Overview
                        </h2>
                        <a href="/agency/tickets" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Buy New Ticket
                        </a>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value"><t t-esc="stats.get('total_orders', 0)"/></div>
                                        <div class="stat-label">Total Orders</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value"><t t-esc="stats.get('today_orders', 0)"/></div>
                                        <div class="stat-label">Today</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value"><t t-esc="stats.get('pending_orders', 0)"/></div>
                                        <div class="stat-label">Pending</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value"><t t-esc="stats.get('confirmed_orders', 0)"/></div>
                                        <div class="stat-label">Confirmed</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                                        <i class="fas fa-euro-sign"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value"><t t-esc="'%.0f' % stats.get('total_revenue', 0)"/></div>
                                        <div class="stat-label">Revenue</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-danger bg-opacity-10 text-danger me-3">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value"><t t-esc="'%.0f' % stats.get('total_commission', 0)"/></div>
                                        <div class="stat-label">Commission</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="filter-card">
                        <form method="get" action="/agency/tickets/overview" class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label small">From Date</label>
                                <input type="date" name="date_from" class="form-control form-control-sm"
                                       t-att-value="filters.get('date_from', '')"/>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">To Date</label>
                                <input type="date" name="date_to" class="form-control form-control-sm"
                                       t-att-value="filters.get('date_to', '')"/>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Status</label>
                                <select name="status" class="form-select form-select-sm">
                                    <option value="all" t-att-selected="filters.get('status') == 'all'">All</option>
                                    <option value="draft" t-att-selected="filters.get('status') == 'draft'">Pending</option>
                                    <option value="sent" t-att-selected="filters.get('status') == 'sent'">Sent</option>
                                    <option value="sale" t-att-selected="filters.get('status') == 'sale'">Confirmed</option>
                                    <option value="cancel" t-att-selected="filters.get('status') == 'cancel'">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Search</label>
                                <input type="text" name="search" class="form-control form-control-sm"
                                       placeholder="Order # or Customer name"
                                       t-att-value="filters.get('search', '')"/>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary btn-sm me-2">
                                    <i class="fas fa-search me-1"></i> Search
                                </button>
                                <a href="/agency/tickets/overview" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-times me-1"></i> Clear
                                </a>
                            </div>
                        </form>
                    </div>

                    <!-- Orders Table -->
                    <div class="orders-table">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Order Date</th>
                                    <th>Visit Date</th>
                                    <th>Customer</th>
                                    <th>Visitors</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-end">Commission</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-if="orders">
                                    <t t-foreach="orders" t-as="order">
                                        <tr>
                                            <td>
                                                <a t-att-href="'/agency/tickets/overview/' + str(order.id)" class="text-primary fw-bold">
                                                    <t t-esc="order.name"/>
                                                </a>
                                            </td>
                                            <td>
                                                <t t-if="order.date_order">
                                                    <t t-esc="order.date_order.strftime('%d/%m/%Y %H:%M')"/>
                                                </t>
                                                <t t-else="">-</t>
                                            </td>
                                            <td>
                                                <t t-if="order.ticket_date">
                                                    <t t-esc="order.ticket_date.strftime('%d/%m/%Y')"/>
                                                </t>
                                                <t t-else="">-</t>
                                            </td>
                                            <td>
                                                <t t-esc="order.partner_id.name if order.partner_id else '-'"/>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">
                                                    <t t-esc="len(order.visitor_form_ids or [])"/> visitors
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold">
                                                <t t-esc="'%.2f' % order.amount_total"/> <t t-esc="order.currency_id.symbol"/>
                                            </td>
                                            <td class="text-end text-danger">
                                                <t t-if="order.commission_amount">
                                                    <t t-esc="'%.2f' % order.commission_amount"/> <t t-esc="order.currency_id.symbol"/>
                                                </t>
                                                <t t-else="">-</t>
                                            </td>
                                            <td class="text-center">
                                                <span t-attf-class="status-badge status-#{order.state}">
                                                    <t t-if="order.state == 'draft'">Pending</t>
                                                    <t t-elif="order.state == 'sent'">Sent</t>
                                                    <t t-elif="order.state == 'sale'">Confirmed</t>
                                                    <t t-elif="order.state == 'cancel'">Cancelled</t>
                                                    <t t-else=""><t t-esc="order.state"/></t>
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group btn-group-sm">
                                                    <a t-att-href="'/agency/tickets/overview/' + str(order.id)"
                                                       class="btn btn-outline-primary action-btn" title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <t t-if="order.state == 'draft'">
                                                        <a t-att-href="'/agency/tickets/overview/' + str(order.id) + '/edit'"
                                                           class="btn btn-outline-warning action-btn" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    </t>
                                                    <button type="button"
                                                            class="btn btn-outline-danger action-btn"
                                                            t-att-onclick="'deleteOrder(' + str(order.id) + ')'"
                                                            title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                                <t t-else="">
                                    <tr>
                                        <td colspan="9" class="text-center py-5 text-muted">
                                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                            No orders found
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>

                <script>
                    async function deleteOrder(orderId) {
                        const result = await Swal.fire({
                            title: 'Are you sure?',
                            text: "This action cannot be undone!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, delete it!',
                            cancelButtonText: 'Cancel'
                        });

                        if (result.isConfirmed) {
                            try {
                                const response = await fetch('/agency/api/tickets/order/delete', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        jsonrpc: '2.0',
                                        method: 'call',
                                        params: { order_id: orderId },
                                        id: Date.now()
                                    })
                                });
                                const data = await response.json();

                                if (data.result &amp;&amp; data.result.success) {
                                    Swal.fire({
                                        title: 'Deleted!',
                                        text: data.result.message,
                                        icon: 'success',
                                        timer: 1500,
                                        showConfirmButton: false
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                } else {
                                    Swal.fire('Error', data.result?.error || 'Failed to delete order', 'error');
                                }
                            } catch (error) {
                                console.error('Delete error:', error);
                                Swal.fire('Error', 'An error occurred', 'error');
                            }
                        }
                    }
                </script>
            </t>
        </template>

        <!-- Order Detail Page -->
        <template id="agency_ticket_order_detail" name="Agency Ticket Order Detail">
            <t t-call="eth_agency_portal.agency_base_template">
                <t t-set="head">
                    <style>
                        .detail-card {
                            background: white;
                            border-radius: 12px;
                            padding: 1.5rem;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                            margin-bottom: 1.5rem;
                        }
                        .detail-label {
                            color: #666;
                            font-size: 0.85rem;
                            margin-bottom: 0.25rem;
                        }
                        .detail-value {
                            font-weight: 600;
                            color: #333;
                        }
                        .visitor-card {
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 1rem;
                            margin-bottom: 0.5rem;
                        }
                    </style>
                </t>

                <div class="container-fluid py-4">
                    <!-- Back Button & Title -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <a href="/agency/tickets/overview" class="btn btn-outline-secondary btn-sm mb-2">
                                <i class="fas fa-arrow-left me-1"></i> Back to Overview
                            </a>
                            <h2 class="mb-0">
                                <i class="fas fa-receipt me-2 text-primary"></i>
                                Order <t t-esc="order.name"/>
                            </h2>
                        </div>
                        <div>
                            <t t-if="order.state == 'draft'">
                                <a t-att-href="'/agency/tickets/overview/' + str(order.id) + '/edit'"
                                   class="btn btn-warning me-2">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </a>
                            </t>
                            <button type="button" class="btn btn-danger" t-att-onclick="'deleteOrder(' + str(order.id) + ')'">
                                <i class="fas fa-trash me-1"></i> Delete
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Order Info -->
                        <div class="col-md-6">
                            <div class="detail-card">
                                <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Order Information</h5>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="detail-label">Order Number</div>
                                        <div class="detail-value"><t t-esc="order.name"/></div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Status</div>
                                        <div class="detail-value">
                                            <span t-attf-class="badge status-badge status-#{order.state}">
                                                <t t-if="order.state == 'draft'">Pending</t>
                                                <t t-elif="order.state == 'sale'">Confirmed</t>
                                                <t t-elif="order.state == 'cancel'">Cancelled</t>
                                                <t t-else=""><t t-esc="order.state"/></t>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Order Date</div>
                                        <div class="detail-value">
                                            <t t-if="order.date_order">
                                                <t t-esc="order.date_order.strftime('%d/%m/%Y %H:%M')"/>
                                            </t>
                                            <t t-else="">-</t>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Visit Date</div>
                                        <div class="detail-value">
                                            <t t-if="order.ticket_date">
                                                <t t-esc="order.ticket_date.strftime('%d/%m/%Y')"/>
                                            </t>
                                            <t t-else="">-</t>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Commission Type</div>
                                        <div class="detail-value">
                                            <t t-if="order.commission_type == 'net'">
                                                <span class="badge bg-info">Net</span>
                                            </t>
                                            <t t-elif="order.commission_type == 'gross'">
                                                <span class="badge bg-warning">Gross</span>
                                            </t>
                                            <t t-else="">-</t>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Commission Amount</div>
                                        <div class="detail-value text-danger">
                                            <t t-if="order.commission_amount">
                                                <t t-esc="'%.2f' % order.commission_amount"/> <t t-esc="order.currency_id.symbol"/>
                                                (<t t-esc="'%.1f' % (order.commission_percentage or 0)"/>%)
                                            </t>
                                            <t t-else="">-</t>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Customer Info -->
                            <div class="detail-card">
                                <h5 class="mb-3"><i class="fas fa-user me-2"></i>Customer Information</h5>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="detail-label">Name</div>
                                        <div class="detail-value"><t t-esc="order.partner_id.name if order.partner_id else '-'"/></div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Email</div>
                                        <div class="detail-value"><t t-esc="order.partner_id.email if order.partner_id else '-'"/></div>
                                    </div>
                                    <div class="col-6">
                                        <div class="detail-label">Phone</div>
                                        <div class="detail-value"><t t-esc="order.partner_id.phone if order.partner_id else '-'"/></div>
                                    </div>
                                    <div class="col-12">
                                        <div class="detail-label">Address</div>
                                        <div class="detail-value">
                                            <t t-if="order.partner_id">
                                                <t t-esc="order.partner_id.street or ''"/>
                                                <t t-if="order.partner_id.street2">, <t t-esc="order.partner_id.street2"/></t>
                                                <t t-if="order.partner_id.city">, <t t-esc="order.partner_id.city"/></t>
                                                <t t-if="order.partner_id.state_id"> / <t t-esc="order.partner_id.state_id.name"/></t>
                                                <t t-if="order.partner_id.country_id"> - <t t-esc="order.partner_id.country_id.name"/></t>
                                            </t>
                                            <t t-else="">-</t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Lines & Visitors -->
                        <div class="col-md-6">
                            <!-- Order Lines -->
                            <div class="detail-card">
                                <h5 class="mb-3"><i class="fas fa-ticket-alt me-2"></i>Order Lines</h5>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th class="text-center">Qty</th>
                                            <th class="text-end">Price</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="order.order_line" t-as="line">
                                            <tr>
                                                <td><t t-esc="line.product_id.name"/></td>
                                                <td class="text-center"><t t-esc="int(line.product_uom_qty)"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % line.price_unit"/></td>
                                                <td class="text-end"><t t-esc="'%.2f' % line.price_subtotal"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                    <tfoot>
                                        <tr class="fw-bold">
                                            <td colspan="3" class="text-end">Total:</td>
                                            <td class="text-end text-primary">
                                                <t t-esc="'%.2f' % order.amount_total"/> <t t-esc="order.currency_id.symbol"/>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Visitors -->
                            <div class="detail-card">
                                <h5 class="mb-3"><i class="fas fa-users me-2"></i>Visitors</h5>
                                <t t-if="visitors">
                                    <t t-foreach="visitors" t-as="visitor">
                                        <div class="visitor-card">
                                            <div class="d-flex justify-content-between">
                                                <strong>
                                                    <t t-esc="visitor.visitor_first_name"/> <t t-esc="visitor.visitor_last_name"/>
                                                </strong>
                                                <span class="badge bg-secondary">
                                                    <t t-esc="visitor.product_template_id.name if visitor.product_template_id else ''"/>
                                                </span>
                                            </div>
                                            <div class="small text-muted mt-1">
                                                <span class="me-3"><i class="fas fa-phone me-1"></i><t t-esc="visitor.visitor_phone"/></span>
                                                <span class="me-3"><i class="fas fa-envelope me-1"></i><t t-esc="visitor.visitor_email"/></span>
                                            </div>
                                            <div class="small text-muted">
                                                <span><i class="fas fa-id-card me-1"></i><t t-esc="visitor.visitor_identity"/></span>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <p class="text-muted text-center py-3">No visitor information</p>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    async function deleteOrder(orderId) {
                        const result = await Swal.fire({
                            title: 'Are you sure?',
                            text: "This action cannot be undone!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, delete it!',
                            cancelButtonText: 'Cancel'
                        });

                        if (result.isConfirmed) {
                            try {
                                const response = await fetch('/agency/api/tickets/order/delete', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        jsonrpc: '2.0',
                                        method: 'call',
                                        params: { order_id: orderId },
                                        id: Date.now()
                                    })
                                });
                                const data = await response.json();

                                if (data.result &amp;&amp; data.result.success) {
                                    Swal.fire({
                                        title: 'Deleted!',
                                        text: data.result.message,
                                        icon: 'success',
                                        timer: 1500,
                                        showConfirmButton: false
                                    }).then(() => {
                                        window.location.href = '/agency/tickets/overview';
                                    });
                                } else {
                                    Swal.fire('Error', data.result?.error || 'Failed to delete order', 'error');
                                }
                            } catch (error) {
                                console.error('Delete error:', error);
                                Swal.fire('Error', 'An error occurred', 'error');
                            }
                        }
                    }
                </script>
            </t>
        </template>

        <!-- Order Edit Page -->
        <template id="agency_ticket_order_edit" name="Agency Ticket Order Edit">
            <t t-call="eth_agency_portal.agency_base_template">
                <t t-set="head">
                    <style>
                        .edit-card {
                            background: white;
                            border-radius: 12px;
                            padding: 1.5rem;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                            margin-bottom: 1.5rem;
                        }
                        .visitor-form-row {
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 1rem;
                            margin-bottom: 0.5rem;
                        }
                    </style>
                </t>

                <div class="container-fluid py-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <a t-att-href="'/agency/tickets/overview/' + str(order.id)" class="btn btn-outline-secondary btn-sm mb-2">
                                <i class="fas fa-arrow-left me-1"></i> Back to Order
                            </a>
                            <h2 class="mb-0">
                                <i class="fas fa-edit me-2 text-warning"></i>
                                Edit Order <t t-esc="order.name"/>
                            </h2>
                        </div>
                    </div>

                    <form id="editOrderForm">
                        <input type="hidden" id="orderId" t-att-value="order.id"/>

                        <!-- Visitors Edit -->
                        <div class="edit-card">
                            <h5 class="mb-3"><i class="fas fa-users me-2"></i>Edit Visitors</h5>
                            <div id="visitorsContainer">
                                <t t-set="visitor_idx" t-value="0"/>
                                <t t-foreach="visitors" t-as="visitor">
                                    <div class="visitor-form-row" t-att-data-index="visitor_idx">
                                        <div class="row g-2">
                                            <div class="col-md-2">
                                                <label class="form-label small">First Name</label>
                                                <input type="text" class="form-control form-control-sm visitor-first-name"
                                                       t-att-value="visitor.visitor_first_name" required="required"/>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">Last Name</label>
                                                <input type="text" class="form-control form-control-sm visitor-last-name"
                                                       t-att-value="visitor.visitor_last_name" required="required"/>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">Phone</label>
                                                <input type="tel" class="form-control form-control-sm visitor-phone"
                                                       t-att-value="visitor.visitor_phone" required="required"/>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Email</label>
                                                <input type="email" class="form-control form-control-sm visitor-email"
                                                       t-att-value="visitor.visitor_email" required="required"/>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Identity</label>
                                                <input type="text" class="form-control form-control-sm visitor-identity"
                                                       t-att-value="visitor.visitor_identity" required="required"/>
                                            </div>
                                            <input type="hidden" class="visitor-product-template-id"
                                                   t-att-value="visitor.product_template_id.id if visitor.product_template_id else ''"/>
                                            <input type="hidden" class="visitor-index" t-att-value="visitor.visitor_index"/>
                                        </div>
                                    </div>
                                    <t t-set="visitor_idx" t-value="visitor_idx + 1"/>
                                </t>
                            </div>
                            <t t-if="not visitors">
                                <p class="text-muted text-center py-3">No visitors to edit</p>
                            </t>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a t-att-href="'/agency/tickets/overview/' + str(order.id)" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="saveBtn">
                                <i class="fas fa-save me-1"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>

                <script>
                    document.getElementById('editOrderForm').addEventListener('submit', async function(e) {
                        e.preventDefault();

                        const orderId = document.getElementById('orderId').value;
                        const visitorRows = document.querySelectorAll('.visitor-form-row');
                        const visitors = [];

                        visitorRows.forEach(row => {
                            visitors.push({
                                first_name: row.querySelector('.visitor-first-name').value,
                                last_name: row.querySelector('.visitor-last-name').value,
                                phone: row.querySelector('.visitor-phone').value,
                                email: row.querySelector('.visitor-email').value,
                                identity: row.querySelector('.visitor-identity').value,
                                product_template_id: row.querySelector('.visitor-product-template-id').value,
                                visitor_index: row.querySelector('.visitor-index').value
                            });
                        });

                        const saveBtn = document.getElementById('saveBtn');
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';

                        try {
                            const response = await fetch('/agency/api/tickets/order/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: { order_id: orderId, visitors: visitors },
                                    id: Date.now()
                                })
                            });
                            const data = await response.json();

                            if (data.result &amp;&amp; data.result.success) {
                                Swal.fire({
                                    title: 'Success!',
                                    text: 'Order updated successfully',
                                    icon: 'success',
                                    timer: 1500,
                                    showConfirmButton: false
                                }).then(() => {
                                    window.location.href = '/agency/tickets/overview/' + orderId;
                                });
                            } else {
                                Swal.fire('Error', data.result?.error || 'Failed to update order', 'error');
                                saveBtn.disabled = false;
                                saveBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save Changes';
                            }
                        } catch (error) {
                            console.error('Update error:', error);
                            Swal.fire('Error', 'An error occurred', 'error');
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save Changes';
                        }
                    });
                </script>
            </t>
        </template>
    </data>
</odoo>
