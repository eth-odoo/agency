<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Agency Base Template - WITH TRANSLATIONS -->
        <template id="agency_base_template" name="Agency Base Template">
            <html>
                <head>
                    <meta charset="utf-8"/>
                    <meta name="viewport" content="width=device-width, initial-scale=1"/>
                    <title>Agency Portal</title>
                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
                    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
                    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                    <style>
                        .agency-header {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 1rem 0;
                            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
                        }
                        .agency-sidebar {
                            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
                            min-height: calc(100vh - 76px);
                            border-right: 1px solid #dee2e6;
                        }
                        .content-area {
                            padding: 2rem;
                            background-color: #f8f9fa;
                        }
                        .nav-link {
                            transition: all 0.3s ease;
                            border-radius: 8px;
                            color: #495057;
                            text-decoration: none;
                        }
                        .nav-link:hover {
                            background-color: rgba(102, 126, 234, 0.1);
                            transform: translateX(5px);
                            color: #667eea;
                        }
                        .nav-link.has-submenu {
                            position: relative;
                        }
                        .nav-link.has-submenu::after {
                            content: '\f107';
                            font-family: 'Font Awesome 6 Free';
                            font-weight: 900;
                            position: absolute;
                            right: 15px;
                            top: 50%;
                            transform: translateY(-50%);
                            transition: transform 0.3s;
                        }
                        .nav-link.has-submenu.collapsed::after {
                            transform: translateY(-50%) rotate(-90deg);
                        }
                        .submenu {
                            padding-left: 20px;
                            margin-top: 5px;
                        }
                        .submenu .nav-link {
                            font-size: 0.9rem;
                            padding: 8px 15px;
                            border-left: 2px solid #e9ecef;
                            margin-bottom: 2px;
                        }
                        .submenu .nav-link:hover {
                            border-left-color: #667eea;
                            background-color: rgba(102, 126, 234, 0.05);
                        }
                        .submenu .nav-link.active {
                            border-left-color: #667eea;
                            background-color: rgba(102, 126, 234, 0.1);
                            color: #667eea;
                        }
                        .membership-badge {
                            font-size: 0.75rem;
                            background: rgba(255,255,255,0.2);
                            padding: 2px 8px;
                            border-radius: 12px;
                        }
                        .language-selector {
                            background: rgba(255, 255, 255, 0.2);
                            border: 1px solid rgba(255, 255, 255, 0.4);
                            color: white;
                            padding: 4px 10px;
                            border-radius: 4px;
                            font-size: 0.9rem;
                            margin-right: 15px;
                        }
                        .language-selector option {
                            background-color: #6c757d;
                            color: white;
                        }
                        /* Notification Bell Styles */
                        .notification-bell {
                            color: white;
                            font-size: 1.2rem;
                            position: relative;
                            text-decoration: none;
                            transition: all 0.3s ease;
                        }
                        .notification-bell:hover {
                            color: #ffc107;
                            transform: scale(1.1);
                        }
                        .notification-count {
                            position: absolute;
                            top: -8px;
                            right: -10px;
                            background: #dc3545;
                            color: white;
                            border-radius: 50%;
                            width: 20px;
                            height: 20px;
                            font-size: 0.7rem;
                            font-weight: bold;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            animation: pulse 2s infinite;
                        }
                        @keyframes pulse {
                            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
                            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
                            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
                        }
                        .notification-bell-container {
                            display: inline-block;
                        }
                    </style>
                    <t t-raw="head"/>
                </head>
                <body>
                    <!-- Header -->
                    <div class="agency-header">
                        <div class="container-fluid">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h4 class="mb-0 fw-bold">
                                        <i class="fas fa-building me-2"></i>
                                        <span t-translate="">Agency Portal</span>
                                        <t t-if="agency_data">
                                            <t t-foreach="agency_data.get('membership_purposes', [])" t-as="purpose">
                                                <span class="membership-badge"><t t-esc="purpose"/></span>
                                            </t>
                                        </t>
                                    </h4>
                                </div>
                                <div class="col-md-6 text-end d-flex align-items-center justify-content-end">
                                    <t t-if="user_data">
                                        <select id="language-selector" class="language-selector agency-language-switcher">
                                            <t t-if="available_languages">
                                                <t t-foreach="available_languages" t-as="lang">
                                                    <option t-att-value="lang[0]"><t t-esc="lang[1]"/></option>
                                                </t>
                                            </t>
                                        </select>

                                        <!-- Notification Bell Icon -->
                                        <div class="notification-bell-container me-3" style="position: relative;">
                                            <a href="/agency/announcements" class="notification-bell" title="Announcements &amp; Messages">
                                                <i class="fas fa-bell"></i>
                                                <span class="notification-count" id="headerNotificationBadge" style="display: none;">0</span>
                                            </a>
                                        </div>

                                        <span class="me-3">
                                            <i class="fas fa-user me-1"></i>
                                            <span><t t-esc="user_data.get('name', 'User')"/></span>
                                        </span>
                                        <a href="/agency/logout" class="btn btn-outline-light btn-sm">
                                            <i class="fas fa-sign-out-alt me-1"></i>
                                            <span t-translate="">Logout</span>
                                        </a>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="container-fluid">
                        <div class="row">
                            <!-- Sidebar -->
                            <div class="col-md-2 agency-sidebar p-3">
                                <nav class="nav flex-column">
                                    <a class="nav-link" href="/agency/dashboard">
                                        <i class="fas fa-tachometer-alt me-2"></i>
                                        <span t-translate="">Dashboard</span>
                                    </a>

                                    <a class="nav-link" href="/agency/users">
                                        <i class="fas fa-users me-2"></i>
                                        <span t-translate="">User Management</span>
                                    </a>

                                    <t t-if="agency_data and agency_data.get('has_sales', False)">
                                        <a class="nav-link has-submenu" data-bs-toggle="collapse" href="#bookingSubMenu" role="button" aria-expanded="false" aria-controls="bookingSubMenu">
                                            <i class="fas fa-hotel me-2"></i>
                                            <span class="menu-text" t-translate="">Booking Management</span>
                                        </a>

                                        <div class="collapse submenu" id="bookingSubMenu">
                                            <a class="nav-link" href="/agency/hotel-bookings">
                                                <i class="fas fa-bed me-2"></i>
                                                <span class="menu-text" t-translate="">Hotel Bookings</span>
                                            </a>
                                        </div>
                                    </t>

                                    <t t-if="agency_data and agency_data.get('has_bonus', False)">
                                        <a class="nav-link has-submenu" data-bs-toggle="collapse" href="#bonusSubMenu" role="button" aria-expanded="false" aria-controls="bonusSubMenu">
                                            <i class="fas fa-star me-2"></i>
                                            <span class="menu-text" t-translate="">Bonus Management</span>
                                        </a>

                                        <div class="collapse submenu" id="bonusSubMenu">
                                            <a class="nav-link" href="/agency/bonus-reservation">
                                                <i class="fas fa-ticket me-2"></i>
                                                <span class="menu-text" t-translate="">Bonus Reservations</span>
                                            </a>

                                            <a class="nav-link" href="/agency/bonus-wallet">
                                                <i class="fas fa-wallet me-2"></i>
                                                <span class="menu-text" t-translate="">Bonus Wallet</span>
                                            </a>
                                        </div>
                                    </t>

                                    <t t-if="agency_data and agency_data.get('has_tickets', False)">
                                        <a class="nav-link has-submenu" data-bs-toggle="collapse" href="#ticketSubMenu" role="button" aria-expanded="false" aria-controls="ticketSubMenu">
                                            <i class="fas fa-ticket-alt me-2"></i>
                                            <span class="menu-text" t-translate="">Ticket Management</span>
                                        </a>

                                        <div class="collapse submenu" id="ticketSubMenu">
                                            <a class="nav-link" href="/agency/tickets/overview">
                                                <i class="fas fa-clipboard-list me-2"></i>
                                                <span class="menu-text" t-translate="">Ticket Overview</span>
                                            </a>
                                            <a class="nav-link" href="/agency/tickets">
                                                <i class="fas fa-shopping-cart me-2"></i>
                                                <span class="menu-text" t-translate="">Buy Ticket</span>
                                            </a>
                                        </div>
                                    </t>

                                    <!-- Communication Menu -->
                                    <a class="nav-link has-submenu" data-bs-toggle="collapse" href="#communicationSubMenu" role="button" aria-expanded="false" aria-controls="communicationSubMenu">
                                        <i class="fas fa-comments me-2"></i>
                                        <span class="menu-text" t-translate="">Communication</span>
                                    </a>

                                    <div class="collapse submenu" id="communicationSubMenu">
                                        <a class="nav-link" href="/agency/announcements">
                                            <i class="fas fa-bullhorn me-2"></i>
                                            <span class="menu-text" t-translate="">Announcements</span>
                                        </a>
                                        <a class="nav-link" href="/agency/messages">
                                            <i class="fas fa-envelope me-2"></i>
                                            <span class="menu-text" t-translate="">Messages</span>
                                        </a>
                                    </div>

                                    <a class="nav-link" href="/agency/reports">
                                        <i class="fas fa-chart-line me-2"></i>
                                        <span t-translate="">Reports</span>
                                    </a>

                                    <a class="nav-link" href="/agency/settings">
                                        <i class="fas fa-cog me-2"></i>
                                        <span t-translate="">Settings</span>
                                    </a>
                                </nav>
                            </div>

                            <!-- Main Content -->
                            <div class="col-md-10 content-area">
                                <t t-raw="0"/>
                            </div>
                        </div>
                    </div>

                    <!-- Floating Communication Widget -->
                    <div id="comm-widget" class="comm-widget">
                        <button class="comm-toggle" onclick="toggleCommWidget()">
                            <i class="fas fa-comments"></i>
                            <span class="comm-badge" id="commBadge" style="display: none;">0</span>
                        </button>
                        <div class="comm-panel" id="commPanel" style="display: none;">
                            <div class="comm-header">
                                <span>Messages &amp; Notifications</span>
                                <button class="comm-close" onclick="toggleCommWidget()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="comm-tabs">
                                <button class="comm-tab active" onclick="showCommTab('messages')">
                                    <i class="fas fa-envelope me-1"></i> Messages
                                    <span class="tab-badge" id="msgBadge" style="display: none;">0</span>
                                </button>
                                <button class="comm-tab" onclick="showCommTab('announcements')">
                                    <i class="fas fa-bullhorn me-1"></i> News
                                    <span class="tab-badge" id="annBadge" style="display: none;">0</span>
                                </button>
                            </div>
                            <div class="comm-content" id="commContent">
                                <div class="comm-loading">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </div>
                            </div>
                            <div class="comm-footer">
                                <a href="/agency/messages/new" class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-plus me-1"></i> New Message
                                </a>
                            </div>
                        </div>
                    </div>

                    <style>
                        .comm-widget {
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            z-index: 9999;
                        }
                        .comm-toggle {
                            width: 60px;
                            height: 60px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #007bff, #0056b3);
                            border: none;
                            color: white;
                            font-size: 1.5rem;
                            cursor: pointer;
                            box-shadow: 0 4px 15px rgba(0,123,255,0.4);
                            transition: all 0.3s;
                            position: relative;
                        }
                        .comm-toggle:hover {
                            transform: scale(1.1);
                        }
                        .comm-badge, .tab-badge {
                            position: absolute;
                            top: -5px;
                            right: -5px;
                            background: #dc3545;
                            color: white;
                            border-radius: 50%;
                            width: 22px;
                            height: 22px;
                            font-size: 0.7rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .tab-badge {
                            position: relative;
                            top: 0;
                            right: 0;
                            width: 18px;
                            height: 18px;
                            font-size: 0.65rem;
                            margin-left: 5px;
                        }
                        .comm-panel {
                            position: absolute;
                            bottom: 70px;
                            right: 0;
                            width: 350px;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
                            overflow: hidden;
                        }
                        .comm-header {
                            background: linear-gradient(135deg, #007bff, #0056b3);
                            color: white;
                            padding: 15px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            font-weight: 600;
                        }
                        .comm-close {
                            background: transparent;
                            border: none;
                            color: white;
                            cursor: pointer;
                            font-size: 1.2rem;
                        }
                        .comm-tabs {
                            display: flex;
                            border-bottom: 1px solid #e9ecef;
                        }
                        .comm-tab {
                            flex: 1;
                            padding: 10px;
                            border: none;
                            background: #f8f9fa;
                            cursor: pointer;
                            font-size: 0.85rem;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .comm-tab.active {
                            background: white;
                            color: #007bff;
                            font-weight: 600;
                        }
                        .comm-content {
                            max-height: 300px;
                            overflow-y: auto;
                            padding: 10px;
                        }
                        .comm-item {
                            padding: 10px;
                            border-radius: 8px;
                            margin-bottom: 8px;
                            background: #f8f9fa;
                            cursor: pointer;
                            transition: all 0.2s;
                        }
                        .comm-item:hover {
                            background: #e9ecef;
                        }
                        .comm-item.unread {
                            border-left: 3px solid #007bff;
                            background: #e7f1ff;
                        }
                        .comm-item-title {
                            font-weight: 600;
                            font-size: 0.9rem;
                            margin-bottom: 3px;
                        }
                        .comm-item-preview {
                            font-size: 0.8rem;
                            color: #6c757d;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }
                        .comm-item-date {
                            font-size: 0.7rem;
                            color: #adb5bd;
                            margin-top: 3px;
                        }
                        .comm-footer {
                            padding: 10px;
                            border-top: 1px solid #e9ecef;
                        }
                        .comm-loading, .comm-empty {
                            text-align: center;
                            padding: 30px;
                            color: #6c757d;
                        }
                    </style>

                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
                    <script>
                        window.currentLanguage = '<t t-esc="current_language"/>';

                        // Communication Widget Functions
                        let currentTab = 'messages';

                        function toggleCommWidget() {
                            const panel = document.getElementById('commPanel');
                            if (panel.style.display === 'none') {
                                panel.style.display = 'block';
                                loadCommContent();
                            } else {
                                panel.style.display = 'none';
                            }
                        }

                        function showCommTab(tab) {
                            currentTab = tab;
                            document.querySelectorAll('.comm-tab').forEach(t => t.classList.remove('active'));
                            event.target.closest('.comm-tab').classList.add('active');
                            loadCommContent();
                        }

                        async function loadCommContent() {
                            const content = document.getElementById('commContent');
                            content.innerHTML = '<div class="comm-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

                            try {
                                if (currentTab === 'messages') {
                                    const resp = await fetch('/agency/api/messages/unread-count', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({jsonrpc: '2.0', method: 'call', params: {}, id: Date.now()})
                                    });
                                    const data = await resp.json();
                                    // For now show link to messages
                                    content.innerHTML = `
                                        <div class="comm-empty">
                                            <i class="fas fa-envelope fa-2x mb-2"></i>
                                            <p>View all your conversations</p>
                                            <a href="/agency/messages" class="btn btn-outline-primary btn-sm">Go to Messages</a>
                                        </div>
                                    `;
                                } else {
                                    content.innerHTML = `
                                        <div class="comm-empty">
                                            <i class="fas fa-bullhorn fa-2x mb-2"></i>
                                            <p>View announcements and campaigns</p>
                                            <a href="/agency/announcements" class="btn btn-outline-primary btn-sm">Go to Announcements</a>
                                        </div>
                                    `;
                                }
                            } catch(e) {
                                content.innerHTML = '<div class="comm-empty">Error loading content</div>';
                            }
                        }

                        // Load notification counts on page load
                        async function loadNotificationCounts() {
                            try {
                                let totalUnread = 0;

                                // Messages count
                                const msgResp = await fetch('/agency/api/messages/unread-count', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({jsonrpc: '2.0', method: 'call', params: {}, id: Date.now()})
                                });
                                const msgData = await msgResp.json();
                                if (msgData.result &amp;&amp; msgData.result.success &amp;&amp; msgData.result.unread_count > 0) {
                                    document.getElementById('msgBadge').style.display = 'flex';
                                    document.getElementById('msgBadge').textContent = msgData.result.unread_count;
                                    totalUnread += msgData.result.unread_count;
                                }

                                // Announcements count
                                const annResp = await fetch('/agency/api/announcements/unread-count', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({jsonrpc: '2.0', method: 'call', params: {}, id: Date.now()})
                                });
                                const annData = await annResp.json();
                                if (annData.result &amp;&amp; annData.result.success &amp;&amp; annData.result.unread_count > 0) {
                                    document.getElementById('annBadge').style.display = 'flex';
                                    document.getElementById('annBadge').textContent = annData.result.unread_count;
                                    totalUnread += annData.result.unread_count;
                                }

                                // Update header notification badge
                                updateHeaderBadge(totalUnread);
                                updateMainBadge();
                            } catch(e) {
                                console.log('Error loading notifications:', e);
                            }
                        }

                        function updateHeaderBadge(count) {
                            const headerBadge = document.getElementById('headerNotificationBadge');
                            if (headerBadge) {
                                if (count > 0) {
                                    headerBadge.style.display = 'flex';
                                    headerBadge.textContent = count > 99 ? '99+' : count;
                                } else {
                                    headerBadge.style.display = 'none';
                                }
                            }
                        }

                        function updateMainBadge() {
                            const msgCount = parseInt(document.getElementById('msgBadge').textContent) || 0;
                            const annCount = parseInt(document.getElementById('annBadge').textContent) || 0;
                            const total = msgCount + annCount;
                            if (total > 0) {
                                document.getElementById('commBadge').style.display = 'flex';
                                document.getElementById('commBadge').textContent = total;
                            }
                        }

                        $(document).ready(function() {
                            if (window.currentLanguage) {
                                $('#language-selector').val(window.currentLanguage);
                            }

                            $('#language-selector').on('change', function() {
                                var langCode = $(this).val();
                                // Use HTTP redirect for proper cookie handling
                                window.location.href = '/agency/set-language/' + langCode;
                            });

                            // Load notification counts
                            loadNotificationCounts();
                        });
                    </script>
                </body>
            </html>
        </template>

        <!-- Access Denied Template -->
        <template id="agency_access_denied" name="Agency Access Denied">
            <t t-call="eth_agency_portal.agency_base_template">
                <div class="container">
                    <div class="row justify-content-center mt-5">
                        <div class="col-md-8">
                            <div class="alert alert-danger">
                                <h4 class="alert-heading">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span t-translate="">Access Denied</span>
                                </h4>
                                <p class="mb-0"><t t-esc="message"/></p>
                            </div>
                            <a href="/agency/dashboard" class="btn btn-primary">
                                <i class="fas fa-arrow-left me-2"></i>
                                <span t-translate="">Back to Dashboard</span>
                            </a>
                        </div>
                    </div>
                </div>
            </t>
        </template>
    </data>
</odoo>
